var tcart_newDelivery={deliveryState:{currentRequest:null,projectId:null,city:{},services:{},searchboxes:{},focusoutTimers:{},cityCoordinates:null,ymapApiKey:null,cityGuid:null,streetGuid:null,currencyCode:null,pickupList:null,postalCode:null,staticCities:null,geoData:null,autocompleteData:{cities:null},badResponseCounters:{services:0},activeServiceUid:null,freeDeliveryThreshold:null,fullNames:{city:"",street:"",house:"",pickup:""}},init:function(e){console.log("NEW DELIVERY INIT"),window.tcart_newDeliveryActive=!0,this.deliveryState.projectId=parseInt($("#allrecords").attr("data-tilda-project-id"),10),this.deliveryState.currencyCode=$(".t706").attr("data-project-currency-code"),this.deliveryState.ymapApiKey=e,this.deliveryState.ymapApiKey&&this.mapAppendScript("",e);var n=this,l=$(".t-radio__wrapper-delivery").first();0<$(".t-radio__wrapper-delivery").length&&$(".t-radio__wrapper-delivery").html(""),l.attr("id","customdelivery");var t=tcart_newDelivery.createTitle(tcart__dict(30,"Delivery"));l.append(t),this.appendStyleFromSettings(),$.when(this.getCityFromGeo(this.deliveryState.projectId)).then(function(e){var t,r,a,i,s,o,d;e&&(t=tcart_newDelivery.createInput("",tcart__dict(23,"City"),null,null,null,null,"searchbox-input load js-tilda-rule","tildadelivery-city",null,null,!0,null,"chosevalue"),r=n.createSearchbox(t,"city-searchbox"),a=tcart_newDelivery.createInput("","",null,null,null,null,"","tildadelivery-postalcode",!0),i=tcart_newDelivery.createInput("","hash",null,null,null,null,"","tildadelivery-hash",!0),s=tcart_newDelivery.createInput("","country",null,null,null,null,"","tildadelivery-country",!0),l.append(a),l.append(i),l.append(s),l.append(r.outerHTML),n.searchboxInit("city-searchbox","city"),(o=document.createElement("div")).id="delivery-services-wrapper",l.append(o),(n.deliveryState.geoData=e).cities?(d=e.cities[0],n.deliveryState.staticCities=e.cities):d=e,d&&(n.deliveryState.city=d,n.deliveryState.cityGuid=d.guid,n.deliveryState.countryIso=d.countryIso,n.deliveryState.postalCode=d.postalCode,n.deliveryState.cityPostalCode=d.postalCode),""!==d.name?($("#city-searchbox").find(".t-input-description").html(d.fullName),$('[name="tildadelivery-country"]').val(d.countryIso),n.deliveryState.ymapApiKey&&$.when(n.getCityCoordinates("yandex",d.name)).done(function(e){var t;try{(t=e.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(" "))&&(t=[t[1],t[0]],n.deliveryState.cityCoordinates=t)}catch(e){console.error(e)}}),n.deliveryState.searchboxes["city-searchbox"]||(n.deliveryState.searchboxes["city-searchbox"]={}),n.deliveryState.searchboxes["city-searchbox"].address=d,n.deliveryState.fullNames.city=d.fullName,$('input[name="tildadelivery-city"]').val(d.name),$('input[name="tildadelivery-city"]').attr("data-option-selected",!0),n.setPostalCodeInput(d.postalCode),n.renderServices(d.postalCode)):$(".t706 #city-searchbox input").removeClass("load").attr("readonly",!1))},function(){var e=tcart_newDelivery.createInput("",tcart__dict(22,"Commentary"),tcart__dict(41,"Delivery data for manager"),null,null,null,"","delivery-badresponse-comment",null,null,!0),t='<div style="margin: 20px 0; line-height: 22px; color: red;" class="t-text">';t+=tcart__dict(42,'Unfortunately, the delivery service is currently unavailable. Please indicate the delivery address in a free form in the "Comment" field, the store manager will contact you shortly on the contact information provided'),t+="</div>",window.tcart&&(window.tcart.system="none"),l.append(t),l.append(e)}),$(document).keydown(function(e){77==e.keyCode&&console.log(n.deliveryState)}),$(document).on("click",".t-input-clear",function(){var e=$(this).closest(".searchbox-wrapper").attr("id");$("#"+e).find(".searchbox-list").html("");var t=n.deliveryState.focusoutTimers[e];clearTimeout(t),$(this).siblings(".searchbox-input").val(""),$(this).closest(".t-input-block").removeClass("active"),$(this).siblings(".searchbox-input").focus(),n.deliveryState.searchboxes[e]&&n.deliveryState.searchboxes[e].address&&(n.deliveryState.searchboxes[e].address=null)}),$(document).on("click",".searchbox-change-pickup",function(){$(this).closest(".searchbox-wrapper").removeClass("show-info")}),this.renderFullAddressNode()},appendStyleFromSettings:function(){var e,t=document.querySelector("script"),r=$(".t706 .t-form__inputsbox .t-input-group").find('input[type="text"]').first(),a="";r.length?(e=r[0],r.hasClass("t-input_bbonly")&&(a+="outline: none; padding-left: 0!important; padding-right: 0!important; border-top: 0!important; border-right: 0!important; border-left: 0!important; background-color: transparent!important; border-radius: 0!important;"),a+=e.style.cssText):a+="color: #000000; border: 1px solid #000000;";var i=document.createElement("style");i.innerHTML=".t706 .t-form__inputsbox #customdelivery .t-input {"+a+"}",t.parentNode.insertBefore(i,t);var s,o,d=$(".t706 .t-form__inputsbox .t-input-group").find(".t-input-title").first();d.length&&(s="",s+=d[0].style.cssText,(o=document.createElement("style")).innerHTML=".t706 .t-form__inputsbox #customdelivery .t-input-title {"+s+"}",t.parentNode.insertBefore(o,t))},disableChoseServiceControls:function(){$('.t706 input[name="tildadelivery-type"]').attr("disabled","disabled")},enableChoseServiceControls:function(){$('.t706 input[name="tildadelivery-type"]').attr("disabled",!1)},getFullAddress:function(){var e=this.deliveryState.fullNames,t="";return e.pickup?t+=e.city+", "+e.pickup:e.street&&(t+=e.city+", "+e.street),e.house&&(t+=" "+e.house),t},renderFullAddressNode:function(){var e=document.createElement("div");e.classList.add("delivery-full-address"),e.classList.add("t-descr");var t=document.querySelector(".t706__cartwin-totalamount-info");$(t).after(e)},setFullAddress:function(e){document.querySelector(".delivery-full-address").innerHTML=e},changeCartInputsHandler:function(){var e=$(".t706"),t=this;e.find("input").on("change",function(){t.fillTcartDelivery()})},fillTcartDelivery:function(){var a=$(".t706");["city","street","pickup-name","pickup-address","pickup-id","house","entrance","floor","aptoffice","phone","entrancecode","comment","service-id","hash","postalcode","country","userinitials","onelineaddress"].forEach(function(e){var t="",r="tildadelivery-"+e;switch(e){case"service-id":t=a.find('[name="tildadelivery-type"]:checked').attr("data-service-id");break;case"pickup-id":t=a.find("[data-pickup-id]").attr("data-pickup-id");break;case"pickup-address":t=a.find("[data-pickup-address]").attr("data-pickup-address");break;default:t=a.find("[name="+r+"]").val()}t&&window.tcart.delivery&&(window.tcart.delivery[e]=t)})},mapAppendScript:function(e,t){var r=document.createElement("script");r.src="https://api-maps.yandex.ru/2.1/?apikey="+t+"&lang=ru_RU",$("head").append(r)},mapInit:function(e){switch(e){case"yandex":var t,r;void 0!==window.ymaps&&((t=document.createElement("div")).id="delivery-yandex-map",$("#pickup-searchbox .searchbox-inner-wrapper").append(t),r=this,window.ymaps.ready(function(){window.deliveryMap=new ymaps.Map("delivery-yandex-map",{center:r.deliveryState.cityCoordinates||[55.76,37.64],zoom:8,controls:["zoomControl"],maxZoom:20},{yandexMapDisablePoiInteractivity:!0})}))}},mapAddPoints:function(e,u,p){var v=this;void 0!==window.ymaps&&window.ymaps.ready(function(){window.deliveryMap.geoObjects&&window.deliveryMap.geoObjects.removeAll();var t=[];u.forEach(function(e){0===e.coordinates[0]&&0===e.coordinates[1]||t.push(e.coordinates)});for(var e=new ymaps.Clusterer({preset:"islands#circleIcon",groupByCoordinates:!1,clusterDisableClickZoom:!1,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1}),r=[],c=0,a=t.length;c<a;c++)r[c]=new ymaps.Placemark(t[c],function(e){var t=u[e],r=t.name,a=t.address||"",i=t.workTime||"",s=t.phones||"",o=t.addressComment||"",d="";d+="<b>"+r+"</b>";var n="";n+="<b>"+tcart__dict(31,"Address")+": </b>"+a+"</br>";var l="";return t.cash&&"n"===t.cash&&(l+="cash"),n+='<div style="margin: 10px 0;" class="delivery-map-point-select" '+(l?'data-restrictions="'+l+'"':"")+" data-point-index="+e+' onclick="window.tcart__chosePointOnMap(this); return false;">'+tcart__dict(37,"Select")+"</div>",n+=o?o+"</br>":"",n+=i?"<b>"+tcart__dict(40,"Working hours")+": </b>"+i+"</br>":"",s.length&&(n+=(1<s.length?"<b>"+tcart__dict(38,"Phones")+": </b>":"<b>"+tcart__dict(39,"Phone")+": </b>")+s.join(", ")+"</br>"),window.tcart__chosePointOnMap=function(e){c=e.dataset.pointIndex;var t=u[c],r=p.find(".searchbox-input"),a=p.attr("id");tcart__inputErrorHandler.hide(r),v.deliveryState.searchboxes[a]||(v.deliveryState.searchboxes[a]={}),r.attr("data-option-selected",!0),v.deliveryState.fullNames.pickup=t.address,v.deliveryState.postalCode=t.postalCode,v.setPostalCodeInput(t.postalCode),v.changePickupHandler(t.id,t.name,t.postalCode,p,t.address),$('.706 [name="tildadelivery-pickup-name"]').val(t.name),v.fillTcartDelivery(),window.deliveryMap.balloon.close(),v.showPickupInfo(t.id,p),v.hidePaymentMethod(e)},{balloonContentHeader:d,balloonContentBody:n,balloonContentFooter:""}}(c),{preset:"islands#circleIcon",index:c});e.options.set({gridSize:80,clusterDisableClickZoom:!1}),e.add(r),window.deliveryMap.geoObjects.add(e),window.deliveryMap.setBounds(e.getBounds(),{checkZoomRange:!0}).then(function(){20<window.deliveryMap.getZoom()&&window.deliveryMap.setZoom(18)},this)})},setPostalCodeInput:function(e){$(".t706").find('input[name="tildadelivery-postalcode"]').val(e)},setHashInput:function(e){$(".t706").find('input[name="tildadelivery-hash"]').val(e)},createSearchbox:function(e,t){var r=document.createElement("div");$(r).addClass("searchbox-wrapper"),$(r).attr("id",t);var a=document.createElement("div");$(a).addClass("searchbox-inner-wrapper"),$(a).append(e);var i=document.createElement("div");$(i).addClass("searchbox-list"),$(a).append(i),$(r).append(a);var s=document.createElement("div");return $(s).addClass("searchbox-info"),$(r).append(s),r},searchboxInit:function(r,a){var i,s=$("#"+r),o=$(s).find(".searchbox-input"),d=o.closest(".t-input-block"),n=this;$(o).on("paste keyup",function(e){var t=e;clearTimeout(i),n.deliveryState.searchboxes[r]&&(n.deliveryState.searchboxes[r].address=null),n.deliveryState.searchboxes[r]&&"pickup"!==a&&(n.deliveryState.searchboxes[r].autocompleteAddress=null),""===o.val()||d.hasClass("active")||d.addClass("active"),i=setTimeout(function(){n.changeSearchboxInputHandler(t,s,a),i=null},500)}),$(o).on("focusout",function(){clearTimeout(i),n.focusoutSearchboxInputHandler(s,a)}),$(o).on("click",function(e){clearTimeout(i),n.clickSearchboxInputHandler(e,s,a)})},clickSearchboxInputHandler:function(e,a,i){var s=$(a).find(".searchbox-input"),t=s.closest(".t-input-block");if(""===s.val()||t.hasClass("active")||t.addClass("active"),!(0<$(a).find(".searchbox-list-item").length||s.hasClass("load"))){a.unbind();var r,o,d=parseInt(s.attr("data-service-id"));d&&(r=this.deliveryState.services[d].strongAddress);var n=this,l=$(a).find(".searchbox-list"),c=a.attr("id");this.deliveryState.searchboxes[c]&&"pickup"!==i&&(this.deliveryState.searchboxes[c].autocompleteAddress=null);var u,p,v,y=e.target.value;switch(a.hasClass("load")||(o=setTimeout(function(){a.addClass("load").attr("readonly",!0)},500)),i){case"city":if(u={pattern:y},u=JSON.stringify(u),n.deliveryState.searchboxes[c]&&(n.deliveryState.searchboxes[c].autocompleteAddress||n.deliveryState.staticCities)){if(clearTimeout(o),a.removeClass("load").attr("readonly",!1),(v=n.deliveryState.staticCities||n.deliveryState.searchboxes[c].autocompleteAddress).error||0===v.length)return void(""!==s.val()?l.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):l.html(""));n.deliveryState.searchboxes[c].autocompleteAddress=v[0],n.deliveryState.searchboxes[c].addresses=v,n.deliveryState.autocompleteData.cities=v,n.fillSearchList(l,v,"address"),n.choseSearchListItemHandler(a,i)}else $.when(n.getAddresses(u,i)).done(function(e){clearTimeout(o),a.removeClass("load").attr("readonly",!1),e.error||0===e.length?""!==s.val()?l.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):l.html(""):(n.deliveryState.searchboxes[c].autocompleteAddress=e[0],n.deliveryState.searchboxes[c].addresses=e,n.deliveryState.autocompleteData.cities=e,n.fillSearchList(l,e,"address"),n.choseSearchListItemHandler(a,i))});break;case"pickup":if(p=$(s).attr("data-service-id"),n.deliveryState.searchboxes[c]&&n.deliveryState.searchboxes[c].autocompleteAddress){if(clearTimeout(o),a.removeClass("load").attr("readonly",!1),(v=n.deliveryState.searchboxes[c].autocompleteAddress).error||0===v.length){l.html("");var h=window.tildaBrowserLang.toLowerCase(),m=v.userFriendlyError?v.userFriendlyError[h]?v.userFriendlyError[h]:v.userFriendlyError.en:"";return void(v.error&&tcart__errorHandler.show(m||v.error))}v=v.filter(function(e){return-1!==e.name.toLowerCase().indexOf(y.toLowerCase())||-1!==e.address.toLowerCase().indexOf(y.toLowerCase())}),n.deliveryState.searchboxes[c]||(n.deliveryState.searchboxes[c]={}),n.fillSearchList(l,v,"pickup"),n.choseSearchListItemHandler(a,i)}else $.when(n.getPickupList(n.deliveryState.projectId,n.deliveryState.city.postalCode,p,y)).done(function(e){var t,r;clearTimeout(o),a.removeClass("load").attr("readonly",!1),e.error||0===e.length?(""!==s.val()?l.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):l.html(""),t=window.tildaBrowserLang.toLowerCase(),r=e.userFriendlyError?e.userFriendlyError[t]?e.userFriendlyError[t]:e.userFriendlyError.en:"",e.error&&tcart__errorHandler.show(r||e.error)):(n.deliveryState.searchboxes[c]||(n.deliveryState.searchboxes[c]={}),n.deliveryState.searchboxes[c].autocompleteAddress=e,n.deliveryState.pickupList=e,n.fillSearchList(l,e,"pickup"),n.choseSearchListItemHandler(a,i))});break;case"street":u={pattern:y,fias:this.deliveryState.cityGuid},u=JSON.stringify(u),n.deliveryState.searchboxes[c]||(n.deliveryState.searchboxes[c]={}),r&&"street"===i&&s.attr("data-option-selected",!1),$.when(n.getAddresses(u,i)).done(function(e){clearTimeout(o),a.removeClass("load").attr("readonly",!1),e.error||0===e.length?""!==s.val()?l.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):l.html(""):(n.deliveryState.searchboxes[c].autocompleteAddress=e[0],n.fillSearchList(l,e,"address"),n.choseSearchListItemHandler(a,i))});break;case"house":u={pattern:y,fias:this.deliveryState.streetGuid||this.deliveryState.cityGuid},u=JSON.stringify(u),$.when(n.getAddresses(u,i)).done(function(e){clearTimeout(o),a.removeClass("load").attr("readonly",!1),e.error||0===e.length?l.html(""):(n.deliveryState.searchboxes[c]||(n.deliveryState.searchboxes[c]={}),n.deliveryState.searchboxes[c].autocompleteAddress=e[0],n.fillSearchList(l,e,"address"),n.choseSearchListItemHandler(a,i))});break;default:clearTimeout(o),a.removeClass("load").attr("readonly",!1)}}},changeSearchboxInputHandler:function(e,t,r){t.unbind();var a,i,s=this,o=$(t).find(".searchbox-list"),d=$(t).find(".searchbox-input"),n=d.closest(".t-input-block"),l=t.attr("id"),c=parseInt(d.attr("data-service-id"));if(c&&(a=this.deliveryState.services[c].strongAddress),!d.hasClass("load")){var u,p,v=e.target.value;switch(t.hasClass("load")||(i=setTimeout(function(){t.addClass("load").attr("readonly",!0)},50)),""==d.val()&&n.removeClass("active"),r){case"city":if(u={pattern:v},u=JSON.stringify(u),s.deliveryState.searchboxes[l]||(s.deliveryState.searchboxes[l]={}),s.deliveryState.searchboxes[l]&&s.deliveryState.staticCities){if(clearTimeout(i),t.removeClass("load").attr("readonly",!1),p=s.deliveryState.staticCities,Array.isArray(p)?p=p.filter(function(e){return-1!==e.name.toLowerCase().indexOf(v.toLowerCase())||-1!==e.fullName.toLowerCase().indexOf(v.toLowerCase())}):console.log(p),0===p.length)return void(""!==d.val()?o.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):o.html(""));s.deliveryState.searchboxes[l].autocompleteAddress=p[0],s.deliveryState.searchboxes[l].addresses=p,s.deliveryState.autocompleteData.cities=p,s.fillSearchList(o,p,"address"),s.choseSearchListItemHandler(t,r)}else $.when(s.getAddresses(u,r)).done(function(e){clearTimeout(i),t.removeClass("load").attr("readonly",!1),e.error||0===e.length?""!==d.val()?o.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):o.html(""):(s.deliveryState.searchboxes[l].autocompleteAddress=e[0],s.deliveryState.searchboxes[l].addresses=e,s.deliveryState.autocompleteData.cities=e,s.fillSearchList(o,e,"address"),s.choseSearchListItemHandler(t,r))});break;case"pickup":if(d.attr("data-option-selected",!1),s.deliveryState.searchboxes[l]&&s.deliveryState.searchboxes[l].autocompleteAddress){if(clearTimeout(i),t.removeClass("load").attr("readonly",!1),0===(p=(p=s.deliveryState.searchboxes[l].autocompleteAddress).filter(function(e){return-1!==e.name.toLowerCase().indexOf(v.toLowerCase())||-1!==e.address.toLowerCase().indexOf(v.toLowerCase())})).length)return void(""!==d.val()?o.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):o.html(""));s.fillSearchList(o,p,"pickup"),s.choseSearchListItemHandler(t,r)}break;case"street":u={pattern:v,fias:this.deliveryState.cityGuid},u=JSON.stringify(u),s.deliveryState.searchboxes[l]||(s.deliveryState.searchboxes[l]={}),a&&d.attr("data-option-selected",!1),$.when(s.getAddresses(u,r)).done(function(e){clearTimeout(i),t.removeClass("load").attr("readonly",!1),e.error||0===e.length?""!==d.val()?o.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):o.html(""):(s.deliveryState.searchboxes[l].autocompleteAddress=e[0],s.deliveryState.searchboxes[l].addresses=e,s.fillSearchList(o,e,"address"),s.choseSearchListItemHandler(t,r))});break;case"house":u={pattern:v,fias:this.deliveryState.streetGuid||this.deliveryState.cityGuid},u=JSON.stringify(u),s.deliveryState.searchboxes[l]||(s.deliveryState.searchboxes[l]={}),$.when(s.getAddresses(u,r)).done(function(e){clearTimeout(i),t.removeClass("load").attr("readonly",!1),e.error||0===e.length?""!==d.val()?o.html('<div class="searchbox-list-item t-text" style="user-select: none; pointer-events: none;">'+tcart__dict(45,"No results were found for your request")+"</div>"):o.html(""):(s.deliveryState.searchboxes[l].autocompleteAddress=e[0],s.deliveryState.searchboxes[l].addresses=e,s.fillSearchList(o,e,"address"),s.choseSearchListItemHandler(t,r))})}}},choseSearchListItemHandler:function(a,i){var s,o,d,n=a.attr("id"),l=$(a).find(".searchbox-input"),c=$(a).find(".t-input-description"),u=$(a).find(".searchbox-list"),e=$(a).find(".searchbox-list-item"),p=this,v=l.closest(".t-input-block");tcart__inputErrorHandler.hide(l),e.on("click",function(t){switch(v.removeClass("active"),o=p.deliveryState.focusoutTimers[n],clearTimeout(o),s=t.target.dataset.postalcode,p.deliveryState.postalCode=s,p.setPostalCodeInput(s),p.deliveryState.searchboxes[n]||(p.deliveryState.searchboxes[n]={}),i){case"city":l.addClass("load").attr("readonly",!0),tcart__errorHandler.hide(),l.val(t.target.dataset.name),c.html(t.target.dataset.fullName),$('.t706 [name="tildadelivery-country"]').val(t.target.dataset.countryIso),l.attr("data-guid",t.target.dataset.guid),p.deliveryState.ymapApiKey&&$.when(p.getCityCoordinates("yandex",t.target.dataset.name)).done(function(e){var t;try{(t=e.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(" "))&&(t=[t[1],t[0]],p.deliveryState.cityCoordinates=t)}catch(e){console.error(e)}}),p.deliveryState.searchboxes[n].address={name:t.target.dataset.name,postalCode:s,guid:t.target.dataset.guid},p.deliveryState.city={name:t.target.dataset.name,fullName:t.target.dataset.fullName,postalCode:s,guid:t.target.dataset.guid},p.deliveryState.cityPostalCode=s;var e=p.deliveryState.autocompleteData.cities.find(function(e){return e.guid==t.target.dataset.guid});p.deliveryState.geoData=e,p.deliveryState.cityGuid=t.target.dataset.guid,p.deliveryState.streetGuid=null,p.deliveryState.fullNames={},p.deliveryState.fullNames.city=t.target.dataset.fullName,$("#delivery-services-wrapper").html(""),p.renderServices(s);break;case"street":d=parseInt(l.attr("data-service-id")),l.val(t.target.dataset.shortname),l.attr("data-guid",t.target.dataset.guid),p.deliveryState.searchboxes[n].address={name:t.target.dataset.name,shortName:t.target.dataset.shortname,postalCode:s,guid:t.target.dataset.guid},p.deliveryState.streetGuid=t.target.dataset.guid,p.deliveryState.fullNames.street=t.target.dataset.shortname,p.deliveryState.fullNames.house=null,p.clearHouseInput(),$.when(p.getDeliveryPrice(p.deliveryState.projectId,s,d)).done(function(e){var t,r,a;e.error||0===e.length?(t=window.tildaBrowserLang.toLowerCase(),r=e.userFriendlyError?e.userFriendlyError[t]?e.userFriendlyError[t]:e.userFriendlyError.en:"",e.error&&tcart__errorHandler.show(r||e.error)):(e.hash&&p.setHashInput(e.hash),e.price&&(a=e.price,p.updatePriceValueInRadio(a,d)),p.setFullAddress(p.getFullAddress()),tcart__showDeliveryPrice())});break;case"pickup":var r=t.target.dataset.coordinates.split(",");p.hidePaymentMethod(t.target),p.changePickupHandler(t.target.dataset.pickupid,t.target.dataset.name,s,a,t.target.dataset.address,r),p.deliveryState.searchboxes[n].address={name:t.target.dataset.name,pickupid:t.target.dataset.pickupid,postalCode:s},p.deliveryState.fullNames[i]=t.target.dataset.address,p.showPickupInfo(t.target.dataset.pickupid,a);break;case"house":d=parseInt(l.attr("data-service-id")),l.val(t.target.dataset.name),p.deliveryState.searchboxes[n].address={postalCode:s},p.deliveryState.fullNames[i]=t.target.dataset.name,$.when(p.getDeliveryPrice(p.deliveryState.projectId,s,d)).done(function(e){var t,r,a;e.error||0===e.length?(t=window.tildaBrowserLang.toLowerCase(),r=e.userFriendlyError?e.userFriendlyError[t]?e.userFriendlyError[t]:e.userFriendlyError.en:"",e.error&&tcart__errorHandler.show(r||e.error)):(e.hash&&p.setHashInput(e.hash),e.price&&(a=e.price,p.updatePriceValueInRadio(a,d)),p.setFullAddress(p.getFullAddress()),tcart__showDeliveryPrice())})}u.html(""),l.attr("data-option-selected",!0)})},focusoutSearchboxInputHandler:function(a,i){var s,o,d,n=this,l=$(a).find(".searchbox-list"),c=$(a).find(".t-input-description"),u=a.attr("id"),p=$(a).find(".searchbox-input"),v=p.closest(".t-input-block"),y=parseInt(p.attr("data-service-id"));y?(d=this.deliveryState.services[y].strongAddress,p.attr("data-option-selected",!1)):p.attr("data-option-selected",!0),this.deliveryState.focusoutTimers[u]=setTimeout(function(){if(v.removeClass("active"),n.deliveryState.searchboxes[u]&&n.deliveryState.searchboxes[u].address)return tcart__inputErrorHandler.hide(p),void l.html("");switch(i){case"city":var e;n.deliveryState.searchboxes[u]&&n.deliveryState.searchboxes[u].autocompleteAddress&&p.val()===n.deliveryState.searchboxes[u].autocompleteAddress.name?(p.addClass("load").attr("readonly",!0),o=n.deliveryState.searchboxes[u].autocompleteAddress,n.deliveryState.searchboxes[u].address=o,tcart__inputErrorHandler.hide(p),n.deliveryState.ymapApiKey&&$.when(n.getCityCoordinates("yandex",o.name)).done(function(e){var t;try{(t=e.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(" "))&&(t=[t[1],t[0]],n.deliveryState.cityCoordinates=t)}catch(e){console.error(e)}}),s=o.postalCode,n.deliveryState.postalCode=s,n.setPostalCodeInput(s),$('[name="tildadelivery-country"]').val(o.countryIso),p.val(o.name),c.html(o.fullName),p.attr("data-guid",o.guid),n.deliveryState.city.name=o.name,n.deliveryState.city.fullName=o.fullName,n.deliveryState.city.postalCode=s,n.deliveryState.city.guid=o.guid,n.deliveryState.cityPostalCode=s,n.deliveryState.cityGuid=o.guid,n.deliveryState.streetGuid=null,n.deliveryState.fullNames={},n.deliveryState.fullNames[i]=o.fullName,e=n.deliveryState.autocompleteData.cities.find(function(e){return e.guid==o.guid}),n.deliveryState.geoData=e,l.html(""),$("#delivery-services-wrapper").html(""),n.renderServices(s),p.attr("data-option-selected",!0)):(l.html(""),c.html(""),$("#delivery-services-wrapper").html(""),$("#addresses-wrapper").remove(),p.attr("data-option-selected",!1),n.deliveryState.streetGuid=null,n.deliveryState.fullNames={},tcart__inputErrorHandler.show(p,tcart__dict(35,"Please select an city from the options provided")));break;case"street":n.deliveryState.searchboxes[u]&&n.deliveryState.searchboxes[u].autocompleteAddress&&p.val()===n.deliveryState.searchboxes[u].autocompleteAddress.shortName?(o=n.deliveryState.searchboxes[u].autocompleteAddress,n.deliveryState.searchboxes[u].address=o,n.deliveryState.fullNames[i]=o.shortName,tcart__inputErrorHandler.hide(p),s=o.postalCode,n.deliveryState.postalCode=s,p.val(o.shortName),p.attr("data-guid",o.guid),n.deliveryState.streetGuid=o.guid,n.setPostalCodeInput(s),p.attr("data-option-selected",!0),l.html(""),$.when(n.getDeliveryPrice(n.deliveryState.projectId,s,y)).done(function(e){var t,r,a;e.error||0===e.length?(t=window.tildaBrowserLang.toLowerCase(),r=e.userFriendlyError?e.userFriendlyError[t]?e.userFriendlyError[t]:e.userFriendlyError.en:"",e.error&&tcart__errorHandler.show(r||e.error)):(e.hash&&n.setHashInput(e.hash),e.price&&(a=e.price,n.updatePriceValueInRadio(a,y)),n.setFullAddress(n.getFullAddress()),tcart__showDeliveryPrice())})):(d&&(p.attr("data-option-selected",!1),l.html(""),tcart__inputErrorHandler.show(p,tcart__dict(34,"Please select an address from the options provided"))),l.html("")),n.deliveryState.fullNames.house=null,n.clearHouseInput();break;case"house":n.deliveryState.searchboxes[u]&&n.deliveryState.searchboxes[u].autocompleteAddress&&p.val()===n.deliveryState.searchboxes[u].autocompleteAddress.name?(o=n.deliveryState.searchboxes[u].autocompleteAddress,n.deliveryState.searchboxes[u].address=o,n.deliveryState.fullNames[i]=o.name,tcart__inputErrorHandler.hide(p),s=o.postalCode,n.deliveryState.postalCode=s,p.val(o.name),p.attr("data-option-selected",!0),n.setPostalCodeInput(s),l.html(""),$.when(n.getDeliveryPrice(n.deliveryState.projectId,s,y)).done(function(e){var t,r,a;e.error||0===e.length?(t=window.tildaBrowserLang.toLowerCase(),r=e.userFriendlyError?e.userFriendlyError[t]?e.userFriendlyError[t]:e.userFriendlyError.en:"",e.error&&tcart__errorHandler.show(r||e.error)):(e.hash&&n.setHashInput(e.hash),e.price&&(a=e.price,n.updatePriceValueInRadio(a,y)),n.setFullAddress(n.getFullAddress()),tcart__showDeliveryPrice())})):l.html("");break;case"pickup":l.html("");var t=null,r=null;n.deliveryState.searchboxes[u]&&n.deliveryState.searchboxes[u].autocompleteAddress&&(t=o=n.deliveryState.searchboxes[u].autocompleteAddress).forEach(function(e){e.name===p.val()&&(r=e)}),t&&r?(o=r,n.deliveryState.searchboxes[u].address=o,n.deliveryState.fullNames[i]=o.address,tcart__inputErrorHandler.hide(p),p.attr("data-option-selected",!0),n.changePickupHandler(o.id,o.name,o.postalCode,a,o.address,o.coordinates),n.setPostalCodeInput(o.postalCode),n.deliveryState.postalCode=o.postalCode,l.html("")):(p.attr("data-option-selected",!1),tcart__inputErrorHandler.show(p,tcart__dict(34,"Please select an address from the options provided")))}},200)},fillSearchList:function(e,t,s){var o,d,n,l=document.createElement("div");t.forEach(function(e){var t,r=document.createElement("div");switch($(r).addClass("searchbox-list-item t-text"),s){case"pickup":d=e.name,n=e.address;var a="";e.cash&&"n"===e.cash&&(a+="cash"),r.dataset.restrictions=a;break;case"address":n=e.fullName?(d=e.fullName.split(",").reverse()[0],(t=(t=e.fullName).split(",").reverse()).shift(),t=t.join(", ")):(d=e.name,"")}r.dataset.name=e.name,r.dataset.fullName=e.fullName||"",r.dataset.postalcode=e.postalCode,r.dataset.guid=e.guid||"",r.dataset.pickupid=e.id||"",r.dataset.shortname=e.shortName||"",r.dataset.address=e.address||"",r.dataset.coordinates=e.coordinates||"",r.dataset.countryIso=e.countryIso||"";var i=document.createElement("div");i.classList.add("searchbox-list-item-text"),i.innerHTML=d,$(r).append(i),(o=document.createElement("div")).classList.add("searchbox-list-item-description"),o.innerHTML=n,$(r).append(o),$(l).append(r)}),e.html(l.outerHTML),e.scrollTop(0)},showPickupInfo:function(t,e){var r,a=$(e).find(".searchbox-info");e.addClass("show-info"),this.deliveryState.pickupList.forEach(function(e){e.id!=t||(r=e)});var i=r.name,s=r.address||"",o=r.workTime||"",d=r.phones||"",n=r.addressComment||"",l="";l+='<p style="font-weight: 400; margin-bottom: 15px;" class="t-text">'+tcart__dict(33,"Pickup location")+":</p>",l+='<p class="t-text">'+i+"</p>",l+='<p class="t-text">'+tcart__dict(31,"Address")+": "+s+"</p>",n&&(l+='<p class="t-text" style="opacity: 0.6; line-height: 22px; font-size: .9rem;">'+n+"</p>"),l+=o?'<p class="t-text">'+tcart__dict(40,"Working hours")+": "+o+"</p>":"",d.length&&(l+=1<d.length?'<p class="t-text">'+tcart__dict(38,"Phones")+": "+d.join(", ")+"</p>":'<p class="t-text">'+tcart__dict(39,"Phone")+": "+d.join(", ")+"</p>"),l+='<span style="border-bottom: 1px dashed #000; font-weight: 400; margin-top: 10px; display: inline-block; cursor: pointer;" class="t-text searchbox-change-pickup">'+tcart__dict(46,"Change")+"</span>",a.html(l)},declOfNum:function(e,t){return t[4<e%100&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]},renderServices:function(r){this.deliveryState.services={},this.deliveryState.postalCode={},$("#delivery-services-wrapper").html(""),$("#addresses-wrapper").remove();var e=this.deliveryState.cityPostalCode||"",p=this,t=this.deliveryState.currencyCode,a=$(".t706 #city-searchbox input"),i=$(".t-radio__wrapper-delivery").first();$.when(this.getServices(this.deliveryState.projectId,e,t)).then(function(u){if(u.error){var e=window.tildaBrowserLang.toLowerCase(),t=u.userFriendlyError?u.userFriendlyError[e]?u.userFriendlyError[e]:u.userFriendlyError.en:"";return tcart__errorHandler.show(t||u.error),window.tcart.emtpyDeliveryServices=!0,a.removeClass("load").attr("readonly",!1),void tcart__updateDelivery()}0===u.length?(window.tcart.emtpyDeliveryServices=!0,tcart__errorHandler.show(tcart__dict(29,"Unfortunately, delivery to your chosen city is not possible")),a.removeClass("load").attr("readonly",!1)):window.tcart.emtpyDeliveryServices=!1,u.forEach(function(e,t){if(e.currency&&e.currency!==p.deliveryState.currencyCode)return console.error(e.title+": wrong delivery currency ("+e.currency+")"),void(u.length===t+1&&($(".t706__cartwin-content .t706__product").css("pointer-events","unset"),$(".t706__cartwin-content .t-form__inputsbox").css("pointer-events","unset"),$(".t706 #city-searchbox input").removeClass("load").attr("readonly",!1)));p.deliveryState.services[e.id]={},p.deliveryState.services[e.id].fields=e.fields,p.deliveryState.services[e.id].strongAddress=e.strongAddress;var r,a=e.hint||"",i=e.title||"",s=e.minimumPrice||"",o=!1,d=e.freeDeliveryThreshold||"",n=p.declOfNum(e.minimumDeliverTime,[tcart__dict(25,"day"),tcart__dict(26,"days"),tcart__dict(26,"days")]);e.staticPrice&&e.minimumDeliverTime?r=tcart__dict(27,"from")+" "+e.minimumDeliverTime+" "+n+", "+tcart__showPrice(e.staticPrice):e.staticPrice?r=tcart__showPrice(e.staticPrice):e.minimumDeliverTime&&e.minimumPrice?r=tcart__dict(27,"from")+" "+e.minimumDeliverTime+" "+n+", "+tcart__dict(27,"from")+" "+tcart__showPrice(e.minimumPrice):e.minimumPrice?r=tcart__dict(27,"from")+" "+tcart__showPrice(e.minimumPrice):e.minimumDeliverTime&&(r=tcart__dict(27,"from")+" "+e.minimumDeliverTime+" "+n),"delivery"===e.type&&(s="");var l="";"n"===e.cash&&(l+="cash"),0===t&&(o=!0);var c=tcart_newDelivery.createRadio(i,r,s,e.type,null,e.id,t,e.staticPrice,a,e.hash,l,o,d);$("#delivery-services-wrapper").append(c)}),tcart__updateDelivery(),tcart_newDelivery.changeDeliveryTypeListener(),$('#delivery-services-wrapper [checked="checked"]').trigger("change"),$(".t706__cartwin-content .t706__product").css("pointer-events","unset"),$(".t706__cartwin-content .t-form__inputsbox").css("pointer-events","unset"),tcart__showDeliveryPrice()},function(){var e,t;p.deliveryState.badResponseCounters.services++,p.deliveryState.badResponseCounters.services<5?setTimeout(function(){p.renderServices(r)},1e3):(tcart__preloader.hide(),e=tcart_newDelivery.createInput("",tcart__dict(22,"Commentary"),tcart__dict(41,"Delivery data for manager"),null,null,null,"","delivery-badresponse-comment",null,null,!0),t='<div style="margin: 20px 0; line-height: 22px; color: red;" class="t-text">',t+=tcart__dict(42,'Unfortunately, the delivery service is currently unavailable. Please indicate the delivery address in a free form in the "Comment" field, the store manager will contact you shortly on the contact information provided'),t+="</div>",window.tcart&&(window.tcart.system="none"),i.append(t),i.append(e))})},getCityFromGeo:function(e){var t={projectId:e},t=JSON.stringify(t);return $.ajax({type:"POST",url:"https://geoserv.tildacdn.com/api/detect-city/",dataType:"json",data:t,success:function(){},error:function(e){console.error(e)}})},getPayTypes:function(){var e,t=$("#allrecords").data("tilda-paytypes");try{t&&("object"==typeof t||"function"==typeof t)||(t={},$("input[name=paymentsystem]").each(function(){"cash"==$(this).val()?t.cash="y":"banktransfer"==$(this).val()?t.banktransfer="y":t.card="y"}),t.card||t.cash||t.banktransfer||("cash"==(e=$(".t706").eq(0).data("payment-system"))?t.cash="y":"banktransfer"==e?t.banktransfer="y":e&&""!=e&&"none"!=e?t.card="y":t.none="y"),$("#allrecords").data("tilda-paytypes",t))}catch(e){}return t},getServices:function(e,t,r){var a=window.tcart.total;if(!a||a<1)return{error:new Error("items count is empty")};var i={action:"list",projectId:e,postalCode:t=t||0,currency:r,itemsCount:a,cartAmount:window.tcart.prodamount_withdiscount||window.tcart.prodamount||0,geoData:this.deliveryState.geoData||{},products:window.tcart.products||[],paytypes:this.getPayTypes()},i=JSON.stringify(i);return tcart__preloader.show($("#delivery-services-wrapper"),tcart__dict(43,"Receiving delivery services")),tcart__hideDeliveryPrice(),$.ajax({type:"POST",url:"https://delivery.tildacdn.com/cart-api/",data:i,dataType:"json",success:function(){tcart__preloader.hide()},error:function(e){console.error(e)}})},getPickupList:function(e,t,r,a){var i=this.deliveryState.geoData||{},s={action:"pickup-list",projectId:e,postalCode:t,deliveryId:r,pattern:a,itemsCount:window.tcart.total||0,cartAmount:window.tcart.prodamount_withdiscount||window.tcart.prodamount||0,geoData:i,products:window.tcart.products||[],paytypes:this.getPayTypes()},s=JSON.stringify(s);return $.ajax({type:"POST",url:"https://delivery.tildacdn.com/cart-api/",data:s,dataType:"json",success:function(){},error:function(e){console.error(e)}})},getDeliveryPrice:function(e,t,r,a){tcart__hideDeliveryPrice();t=t||0;var i=window.tcart.total||0,s=window.tcart.prodamount_withdiscount||window.tcart.prodamount||0,o=window.tcart.products||[],d=this.deliveryState.cityGuid||0,n={action:"calculate",projectId:e,postalCode:t,deliveryId:r,currency:this.deliveryState.currencyCode,itemsCount:i,cartAmount:s,pickupPointId:a,products:o,guid:d},n=JSON.stringify(n);return $.ajax({type:"POST",url:"https://delivery.tildacdn.com/cart-api/",data:n,dataType:"json",success:function(){},error:function(e){console.error(e)}})},getCityCoordinates:function(e,t){var r="https://geocode-maps.yandex.ru/1.x/?apikey="+this.deliveryState.ymapApiKey+"&format=json&geocode="+t;return $.ajax({type:"GET",url:r,dataType:"json",success:function(){},error:function(e){console.error(e)}})},getAddresses:function(e,t){var r,a=this;switch(this.deliveryState.currentRequest&&a.deliveryState.currentRequest.abort(),t){case"street":r="https://geoserv.tildacdn.com/api/address/";break;case"city":r="https://geoserv.tildacdn.com/api/city/";break;case"pickup":r="https://delivery.tildacdn.com/cart-api/";break;case"house":r="https://geoserv.tildacdn.com/api/house/"}return this.deliveryState.currentRequest=$.ajax({type:"POST",url:r,data:e,dataType:"json",success:function(){a.deliveryState.currentRequest=null},error:function(e){a.deliveryState.currentRequest=null}}),this.deliveryState.currentRequest},createInput:function(e,t,r,a,i,s,o,d,n,l,c,u,p){r=r||"",a=a||"",c=c?1:0;var v="";return v+="<div "+(l?'style="'+l+'"':"")+" "+(n?"hidden":"")+' class="t-input-group t-input-group_in" data-input-lid="">',v+='<div class="t-input-title t-descr t-descr_md" data-redactor-toolbar="no" field="">'+(t=t||"")+"</div>",v+='<div class="t-input-block">',v+='<input class="'+(o=o+" t-input"||"t-input")+'" '+((p=p||"")?'data-tilda-rule="'+p+'"':"")+" "+((u=u||"")?'inputmode="'+u+'"':"")+" "+((e=e||"")?'type="'+e+'"':"")+' data-service-id="'+(s=s||"")+'" '+((i=i||"")?'id="'+i+'"':"")+' name="'+d.toLowerCase()+'" value="'+a+'" placeholder="'+r+'" autocomplete="no" data-tilda-req='+c+" />",v+=' <svg class="t706__search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 88 88"> <path fill="#3f3f3f" d="M85 31.1c-.5-8.7-4.4-16.6-10.9-22.3C67.6 3 59.3 0 50.6.6c-8.7.5-16.7 4.4-22.5 11-11.2 12.7-10.7 31.7.6 43.9l-5.3 6.1-2.5-2.2-17.8 20 9 8.1 17.8-20.2-2.1-1.8 5.3-6.1c5.8 4.2 12.6 6.3 19.3 6.3 9 0 18-3.7 24.4-10.9 5.9-6.6 8.8-15 8.2-23.7zM72.4 50.8c-9.7 10.9-26.5 11.9-37.6 2.3-10.9-9.8-11.9-26.6-2.3-37.6 4.7-5.4 11.3-8.5 18.4-8.9h1.6c6.5 0 12.7 2.4 17.6 6.8 5.3 4.7 8.5 11.1 8.9 18.2.5 7-1.9 13.8-6.6 19.2z"></path> </svg>',v+='<div class="t-input-clear"></div>',v+="</div>",v+='<div class="t-input-error"></div>',v+='<div class="t-input-description t-text t-text_xs" style="color: #505050; margin: 5px 0 0;"></div>',v+="</div>"},createRadio:function(e,t,r,a,i,s,o,d,n,l,c,u,p){e=e||"",t=t||"";var v="";v+='<label class="'+(i=i?i+" t-radio__control t-text t-text_xs":"t-radio__control t-text t-text_xs")+'" '+(s?'data-service-id="'+s+'"':"")+">";var y="<input "+((c=c||"")?'data-restrictions="'+c+'"':"")+((p=p||"")?'data-free-delivery-threshold="'+p+'"':"")+((l=l||"")?'data-hash-value="'+l+'"':"")+" "+((n=n||"")?'data-hint-text="'+n+'"':"")+" "+(d?'data-static-price="'+d+'"':"")+" "+(d?'data-delivery-price="'+d+'"':'data-delivery-price=""')+" "+(u=u&&'checked="checked"')+' data-service-id="'+s+'"type="radio" data-delivery-type='+a+' name="tildadelivery-type" value=""class="t-radio t-radio_delivery js-tilda-rule" data-tilda-req="1">',h=jQuery.parseHTML(y);return $(h).attr("value",e),v+=$(h)[0].outerHTML,v+='<div class="t-radio__indicator" style="border-color:#000000"></div>',v+='<span class="delivery-checkbox-label">'+e+" </span>",v+='<span class="delivery-minimum">'+t+" </span>",v+="</label>"},createTitle:function(e,t){var r="";return r+='<div class="t-name t-name_md'+(t=t||"")+'" style="margin: 20px 0;">'+(e=e||"")+"</div>"},createSelect:function(e,t,r,a,i){var s="";return s+='<label class="t-input-title t-descr t-descr_md">Пункт выдачи</label>',s+='<div class="ss-select delivery-pickup-select">',s+='<select class="ss-input ss-select delivery-select" data-service-id="'+a+'" name="'+(i=i||"")+'">',s+='<option data-point-id="">Не выбран</option>',r.forEach(function(e){s+="<option data-point-id="+e.id+">"+e.address+"</option>"}),s+="</select>",s+="</div>"},changeDeliveryTypeListener:function(){var r=this;$("input[data-delivery-type]").change(function(){var e=parseInt($(this).attr("data-service-id"),10)||0,t=parseInt($(this).attr("data-free-delivery-threshold"),10);r.deliveryState.freeDeliveryThreshold=t||0,r.deliveryState.activeServiceUid=e,tcart__errorHandler.hide(),r.renderAddressFields(this),this.dataset.hashValue&&r.setHashInput(this.dataset.hashValue),r.hidePaymentMethod(this),$("input[data-delivery-type]").each(function(e,t){0<$(t).attr("data-static-price")?$(t).attr("data-delivery-price",$(t).attr("data-static-price")):$(t).attr("data-delivery-price","")}),r.hints.deleteAll(),r.deliveryState.fullNames.pickup=null,r.deliveryState.fullNames.street=null,r.deliveryState.fullNames.house=null,r.deliveryState.searchboxes["pickup-searchbox"]&&(r.deliveryState.searchboxes["pickup-searchbox"]=null),$(this).attr("data-hint-text")&&r.hints.render($(this).attr("data-hint-text")),tcart__updateDelivery()})},hidePaymentMethod:function(e){var t=$(".t706").find("[data-payment-variant-system='cash']"),r=$(".t706").find("[data-payment-variant-system='cash']").parent(),a=r.closest(".t-radio__wrapper-payment").find("[data-payment-variant-system]").not("[data-payment-variant-system='cash']").first();"cash"===e.dataset.restrictions&&t.length?(r.hide(),a.prop("checked",!0),a.trigger("change")):r.show()},updatePriceValueInRadio:function(e,t){$('.t706__cartwin input[data-service-id="'+t+'"]').attr("data-delivery-price",e),tcart__updateDelivery(),tcart__showDeliveryPrice()},changePickupHandler:function(i,e,t,r,a,s){var o,d=$(r).find(".searchbox-input"),n=d.attr("data-service-id"),l=this;t=t||this.deliveryState.city.postalCode,d.attr("data-pickup-id",i),d.attr("data-pickup-address",a),d.val(e),$.when(l.getDeliveryPrice(l.deliveryState.projectId,t,n,i)).done(function(e){var t,r,a=e.price;e.error||0===e.length?(t=window.tildaBrowserLang.toLowerCase(),r=e.userFriendlyError?e.userFriendlyError[t]?e.userFriendlyError[t]:e.userFriendlyError.en:"",e.error&&tcart__errorHandler.show(r||e.error)):(e.hash&&l.setHashInput(e.hash),i||(a=0),l.updatePriceValueInRadio(a,n),l.setFullAddress(l.getFullAddress()))}),s&&(o=0==s[0]&&0==s[1]),s&&window.deliveryMap&&!o&&window.deliveryMap.setCenter(s,16)},renderAddressFields:function(e){this.disableChoseServiceControls();var o=this,t=$(".t-radio__wrapper-delivery").first();0<$("#addresses-wrapper").length&&$("#customdelivery").attr("data-service-id")!==$(e).attr("data-service-id")&&$("#addresses-wrapper").remove(),$("#customdelivery").attr("data-service-id",$(e).attr("data-service-id"));var d=document.createElement("div");d.id="addresses-wrapper",$(d).css("margin","20px 0"),t.append(d);var r=$(e).attr("data-delivery-type"),n=$(e).attr("data-service-id"),l=$(".t706 #city-searchbox input");switch(r){case"pickup":tcart__preloader.show($("#addresses-wrapper"),tcart__dict(44,"Getting a list of points of issue of orders")),$.when(o.getPickupList(o.deliveryState.projectId,o.deliveryState.city.postalCode,n)).done(function(e){if(e.error){var t=window.tildaBrowserLang.toLowerCase(),r=e.userFriendlyError?e.userFriendlyError[t]?e.userFriendlyError[t]:e.userFriendlyError.en:"";return tcart__errorHandler.show(r||e.error),tcart__preloader.hide(),o.enableChoseServiceControls(),void l.removeClass("load").attr("readonly",!1)}tcart__preloader.hide();var a=o.createInput("",tcart__dict(33,"Pickup location"),tcart__dict(24,"Select pickup location"),null,null,n,"searchbox-input js-tilda-rule","tildadelivery-pickup-name",null,null,!0,null,"chosevalue"),i=o.createSearchbox(a,"pickup-searchbox");$("#addresses-wrapper").append(i.outerHTML),o.deliveryState.searchboxes["pickup-searchbox"]={},o.deliveryState.searchboxes["pickup-searchbox"].autocompleteAddress=e,o.deliveryState.pickupList=e,o.deliveryState.ymapApiKey&&o.mapInit("yandex"),o.searchboxInit("pickup-searchbox","pickup",null,e),o.renderUserFields(d,n),o.changeCartInputsHandler();var s=$(".t706 #pickup-searchbox");o.deliveryState.ymapApiKey&&o.mapAddPoints("",e,s),o.enableChoseServiceControls(),l.removeClass("load").attr("readonly",!1)});break;case"delivery":o.renderUserFields(d,n),o.changeCartInputsHandler(),o.enableChoseServiceControls(),(l=$(".t706 #city-searchbox input")).removeClass("load").attr("readonly",!1)}},clearHouseInput:function(){$('.t706 #customdelivery [name="tildadelivery-house"]').val("")},renderUserFields:function(e,t){var r=this.deliveryState.services[t].fields,a=0;for(var i in r)switch(i){case"street":case"comment":case"userInitials":break;default:a++}var s=0;for(var o in r){var d=r[o].autocomplete,n="",l="",c="",u="",p="",v=!0;switch(o){case"street":n=tcart__dict(15,"Street"),l="width: 100%";break;case"house":s++,n=tcart__dict(16,"House"),v=!1;break;case"entrance":s++,n=tcart__dict(17,"Entrance"),c="number",v=!(u="numeric");break;case"floor":s++,n=tcart__dict(18,"Floor"),c="number",v=!(u="numeric");break;case"aptOffice":s++,n=tcart__dict(19,"Apt/Office"),v=!1;break;case"phone":s++,n=tcart__dict(20,"Phone"),c="number",u="numeric";break;case"entranceCode":s++,n=tcart__dict(21,"Entrance code"),v=!1;break;case"comment":n=tcart__dict(22,"Comment"),v=!(l="width: 100%"),p=tcart__dict(36,"Order comment");break;case"oneLineAddress":s++,n=tcart__dict(31,"Address");break;case"userInitials":l="width: 100%",n=tcart__dict(47,"Initials"),p=tcart__dict(48,"Full name")}a===s&&a%2!=0&&(l="width: 100%"),n=n||"";var y,h,m,f,_,b="tildadelivery-"+o;d?(y="house"===o?"":"chosevalue",h=tcart_newDelivery.createInput(c,n,p,"","",t,"searchbox-input js-tilda-rule",b,!1,l,v,u,y),m=o+"-searchbox",f=this.createSearchbox(h,m),$(e).append(f),this.searchboxInit(m,o)):(_=tcart_newDelivery.createInput(c,n,p,"","",t,"js-tilda-rule",b,!1,l,v,u),$(e).append(_))}},hints:{render:function(e){var t=$("#delivery-services-wrapper"),r=document.createElement("div");$(r).addClass("delivery-hint t-text t-text_xs"),r.innerHTML=e,$(t).append(r)},deleteAll:function(){$(".delivery-hint").length&&$(".delivery-hint").remove()}}},tcart__errorHandler={show:function(e){$(".t-form__errorbox-item.js-rule-error-string").html(e),$(".js-errorbox-all").css("display","block"),$(".t-form__errorbox-item.js-rule-error-string").css("display","block")},hide:function(){$(".js-errorbox-all").css("display","none"),$("t-form__errorbox-item.js-rule-error-string").css("display","none")}},tcart__inputErrorHandler={show:function(e,t){var r=e.closest(".t-input-group");r.find(".t-input-error").html(t),r.addClass("js-error-control-box")},hide:function(e){var t=e.closest(".t-input-group");t.find(".t-input-error").html(""),t.removeClass("js-error-control-box")}};function tcart__hideDeliveryPrice(){$(".t706__cartwin-totalamount-info").length&&$(".t706__cartwin-totalamount-info").css("opacity","0"),$(".t706 .delivery-full-address").length&&$(".t706 .delivery-full-address").css("opacity","0")}function tcart__showDeliveryPrice(){$(".t706__cartwin-totalamount-info").length&&$(".t706__cartwin-totalamount-info").css("opacity","1"),$(".t706 .delivery-full-address").length&&$(".t706 .delivery-full-address").css("opacity","1")}var tcart__preloader={show:function(e,t){var r;e.length&&(e.parent().find(".tcart__preloader").length||(r="",r+='<div class="tcart__preloader" style="margin: 20px 0;">',t&&(r+='<div class="t-text" style="text-align: center; opacity: .5; font-size: 15px;">'+t+"</div>"),r+='<div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>',r+="</div>",e.before(r)))},hide:function(){$(".tcart__preloader").remove()}};function arraysEqual(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!=t.length)return!1;for(var r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}function tcart__rerenderDeliveryServices(){clearTimeout(window.rerenderTimer),window.rerenderTimer=setTimeout(function(){$(".t706__cartwin-content .t706__product").css("pointer-events","none"),$(".t706__cartwin-content .t-form__inputsbox").css("pointer-events","none");var r=tcart_newDelivery.deliveryState,e=r.services,u=r.activeServiceUid,p=tcart_newDelivery;if(!u)return $(".t706__cartwin-content .t706__product").css("pointer-events","unset"),void $(".t706__cartwin-content .t-form__inputsbox").css("pointer-events","unset");var a=[],i=[];Object.keys(e).forEach(function(e){a.push(parseInt(e,10))}),$.when(tcart_newDelivery.getServices(r.projectId,r.cityPostalCode,r.currencyCode)).then(function(e){var t;Array.isArray(e)&&e.forEach(function(e){i.push(e.id)}),a.sort(function(e,t){return e-t}),i.sort(function(e,t){return e-t}),!arraysEqual(i,a)&&!i.includes(u)?(tcart_newDelivery.renderServices(r.postalCode),$(".t706__cartwin-content .t706__product").css("pointer-events","unset"),$(".t706__cartwin-content .t-form__inputsbox").css("pointer-events","unset")):($(".t706 #delivery-services-wrapper").find(".t-radio__control").each(function(e,t){$(t).remove()}),Array.isArray(e)&&e.forEach(function(e,t){var r,a,i,s,o,d,n,l,c;e.currency&&e.currency!==p.deliveryState.currencyCode?console.error(e.title+": wrong delivery currency ("+e.currency+")"):(p.deliveryState.services[e.id]={},p.deliveryState.services[e.id].fields=e.fields,p.deliveryState.services[e.id].strongAddress=e.strongAddress,r=e.hint||"",a=e.title||"",i=e.minimumPrice||"",o=e.freeDeliveryThreshold||"",d=p.declOfNum(e.minimumDeliverTime,[tcart__dict(25,"day"),tcart__dict(26,"days"),tcart__dict(26,"days")]),e.staticPrice&&e.minimumDeliverTime?s=tcart__dict(27,"from")+" "+e.minimumDeliverTime+" "+d+", "+tcart__showPrice(e.staticPrice):e.staticPrice?s=tcart__showPrice(e.staticPrice):e.minimumDeliverTime&&e.minimumPrice?s=tcart__dict(27,"from")+" "+e.minimumDeliverTime+" "+d+", "+tcart__dict(27,"from")+" "+tcart__showPrice(e.minimumPrice):e.minimumPrice?s=tcart__dict(27,"from")+" "+tcart__showPrice(e.minimumPrice):e.minimumDeliverTime&&(s=tcart__dict(27,"from")+" "+e.minimumDeliverTime+" "+d),"delivery"===e.type&&(i=""),n="","n"===e.cash&&(n+="cash"),l=!1,e.id===u&&(l=!0),c=tcart_newDelivery.createRadio(a,s,i,e.type,null,e.id,t,e.staticPrice,r,e.hash,n,l,o),$("#delivery-services-wrapper").append(c))}),t="object"==typeof r.postalCode?r.cityPostalCode:r.postalCode,$.when(tcart_newDelivery.getDeliveryPrice(r.projectId,t,u)).done(function(e){var t;e.error?console.error(e.error):(window.tcart.emtpyDeliveryServices=!1,tcart__errorHandler.hide()),e.hash&&tcart_newDelivery.setHashInput(e.hash),e.price&&(t=e.price,tcart_newDelivery.updatePriceValueInRadio(t,u)),tcart__updateDelivery(),tcart_newDelivery.changeDeliveryTypeListener(),$(".t706__cartwin-content .t706__product").css("pointer-events","unset"),$(".t706__cartwin-content .t-form__inputsbox").css("pointer-events","unset"),tcart__showDeliveryPrice()}))})},500)}